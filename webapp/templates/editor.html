<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GeoJSON Editor - CI Sentinel</title>

  <!-- Base Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/index.css') }}">

  <!-- Modular Editor Styles -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/core_editor/base_layout.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/core_editor/project_selection.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/core_editor/forms_components.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/core_editor/field_weight.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/core_editor/project_builder.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/core_editor/responsive.css') }}">
</head>
<body>
  <!-- Header -->
  <header>
    <div class="logo">
      <a href="{{ url_for('main.index') }}" class="logo-link">
        <div class="custom-loader"></div>
        <span class="logo-title">CI Sentinel</span>
      </a>
    </div>
    <nav>
      <div class="nav-links-container">
        <li><a href="{{ url_for('main.index') }}">Home</a></li>
        <li><a href="{{ url_for('main.about') }}">About</a></li>
        <li><a href="{{ url_for('main.editor_page') }}">Editor</a></li>
        <li><a href="{{ url_for('main.datasets') }}">Datasets</a></li>
        <li><a href="{{ url_for('main.docs_page') }}">Docs</a></li>
        <li><a href="{{ url_for('main.contact') }}">Contact</a></li>
      </div>
    </nav>
  </header>

  <!-- Main Container -->
  <div class="container">
    <!-- Workflow Steps - Different for each project type -->
    <div class="workflow-header">
      <!-- Dataset Workflow Steps -->
      <div class="steps" id="datasetSteps">
        <div class="step active" data-step="0">
          <div class="step-number">0</div>
          <div class="step-title">Project Type</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="1">
          <div class="step-number">1</div>
          <div class="step-title">Load Data</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-title">Configure</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-title">Select Fields</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="4">
          <div class="step-number">4</div>
          <div class="step-title">Apply Weights</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="5">
          <div class="step-number">5</div>
          <div class="step-title">Export</div>
        </div>
      </div>

      <!-- Category Workflow Steps -->
      <div class="steps" id="categorySteps" style="display: none;">
        <div class="step active" data-step="0">
          <div class="step-number">0</div>
          <div class="step-title">Project Type</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="1">
          <div class="step-number">1</div>
          <div class="step-title">Select Datasets</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-title">Dataset Weights</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-title">Select Fields</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="4">
          <div class="step-number">4</div>
          <div class="step-title">Field Weights</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="5">
          <div class="step-number">5</div>
          <div class="step-title">Export</div>
        </div>
      </div>

      <!-- Feature Layer Workflow Steps -->
      <div class="steps" id="featurelayerSteps" style="display: none;">
        <div class="step active" data-step="0">
          <div class="step-number">0</div>
          <div class="step-title">Project Type</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="1">
          <div class="step-number">1</div>
          <div class="step-title">Select Categories</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="2">
          <div class="step-number">2</div>
          <div class="step-title">Category Weights</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="3">
          <div class="step-number">3</div>
          <div class="step-title">Select Fields</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="4">
          <div class="step-number">4</div>
          <div class="step-title">Field Weights</div>
          <div class="step-line"></div>
        </div>
        <div class="step" data-step="5">
          <div class="step-number">5</div>
          <div class="step-title">Export</div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Left Panel - Input/Configuration -->
      <div class="panel">

        <!-- Step 0: Project Selection (shared by all) -->
        <div class="step-content active" data-step="0">
          <div class="panel-title">
            <div class="panel-icon">üöÄ</div>
            Choose Your Project Type
          </div>

          <div id="projectSelection">
            <!-- Project selection content will be populated by JavaScript -->
          </div>
        </div>

        <!-- DATASET WORKFLOW STEPS -->
        <!-- Step 1: Load Data (for datasets only) -->
        <div class="step-content dataset-step" data-step="1">
          <div class="panel-title">
            <div class="panel-icon">üìä</div>
            Load Your Data
          </div>

          <div id="dataLoadingSection">
            <!-- Dataset Name Input -->
            <div class="input-group">
              <label class="input-label">Dataset Name*</label>
              <input type="text" id="datasetName" placeholder="Enter dataset name" required>
              <small>This will be the name for your dataset</small>
            </div>

            <!-- Data Source Selection -->
            <div class="input-group">
              <label class="input-label">Choose Data Source</label>
              <select id="dataSourceSelect">
                <option value="">Select data source...</option>
                <option value="file">üì§ Upload File</option>
                <option value="builtin">üè¢ Built-in APIs</option>
                <option value="user">üë§ My Custom APIs</option>
                <option value="custom">üîó Enter Custom URL</option>
                <option value="create">‚ûï Create New API</option>
              </select>
            </div>

            <!-- File Upload Container -->
            <div id="fileUploadContainer" style="display: none;">
              <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üì§</div>
                <h3>Drop your GeoJSON file here</h3>
                <p style="color: #999; margin: 1rem 0;">or click to browse</p>
                <input type="file" id="fileInput" accept=".json,.geojson" style="display: none;">
              </div>
            </div>

            <!-- Built-in APIs Container -->
            <div id="builtInApiContainer" style="display: none;">
              <div class="input-group">
                <label class="input-label">Select Built-in API</label>
                <select id="builtInApiSelect">
                  <option value="">Loading APIs...</option>
                </select>
              </div>
            </div>

            <!-- User APIs Container -->
            <div id="userApiContainer" style="display: none;">
              <div class="input-group">
                <label class="input-label">Select Custom API</label>
                <select id="userApiSelect">
                  <option value="">Loading APIs...</option>
                </select>
              </div>
            </div>

            <!-- Custom URL Container -->
            <div id="customUrlContainer" style="display: none;">
              <div class="input-group">
                <label class="input-label">Custom API URL</label>
                <input type="url" id="customApiUrl" placeholder="https://services.example.com/...">
                <small style="color: #665; margin-top: 0.25rem; display: block;">
                  Enter a direct API URL or ArcGIS Feature Service URL
                </small>
              </div>
            </div>

            <!-- Create New API Container -->
            <div id="createApiContainer" style="display: none;">
              <div class="panel-title" style="margin: 1rem 0 0.5rem 0; font-size: 1rem;">
                <div class="panel-icon">‚ûï</div>
                Create New API
              </div>

              <form id="createApiForm">
                <div class="input-group">
                  <label class="input-label">API Name*</label>
                  <input type="text" name="apiName" placeholder="My Custom API" required>
                </div>

                <div class="input-group">
                  <label class="input-label">API URL*</label>
                  <input type="url" name="apiUrl" placeholder="https://example.com/api/data" required>
                  <small style="color: #665; margin-top: 0.25rem; display: block;">
                    Must return valid GeoJSON with a "features" property
                  </small>
                </div>

                <div class="input-group">
                  <label class="input-label">Description</label>
                  <textarea name="apiDescription" rows="2" placeholder="Brief description of the API..."></textarea>
                </div>

                <div class="input-group">
                  <label class="input-label">Category</label>
                  <input type="text" name="apiCategory" placeholder="Custom" value="Custom">
                </div>

                <div class="btn-group">
                  <button type="button" class="btn btn-secondary" onclick="cancelApiCreation()">Cancel</button>
                  <button type="submit" class="btn btn-primary">Create API</button>
                </div>
              </form>
            </div>

            <button class="btn btn-primary" style="width: 100%; margin-top: 1rem;" onclick="loadData()">
              Load Data
            </button>
          </div>
        </div>

        <!-- CATEGORY WORKFLOW STEPS -->
        <!-- Step 1: Select Datasets (for categories) -->
        <div class="step-content category-step" data-step="1">
          <div class="panel-title">
            <div class="panel-icon">üìÅ</div>
            Select Datasets for Category
          </div>

          <div id="categoryDatasetSelection">
            <!-- Category dataset selection content will be populated by JavaScript -->
          </div>
        </div>

        <!-- Step 2: Apply Dataset Weights (for categories) -->
        <div class="step-content category-step" data-step="2">
          <div class="panel-title">
            <div class="panel-icon">‚öñÔ∏è</div>
            Apply Dataset Weights
          </div>

          <div id="categoryDatasetWeights">
            <!-- Category dataset weights will be populated by JavaScript -->
          </div>
        </div>

        <!-- FEATURE LAYER WORKFLOW STEPS -->
        <!-- Step 1: Select Categories (for feature layers) -->
        <div class="step-content featurelayer-step" data-step="1">
          <div class="panel-title">
            <div class="panel-icon">üó∫Ô∏è</div>
            Select Categories for Feature Layer
          </div>

          <div id="featureLayerCategorySelection">
            <!-- Feature layer category selection content will be populated by JavaScript -->
          </div>
        </div>

        <!-- Step 2: Apply Category Weights (for feature layers) -->
        <div class="step-content featurelayer-step" data-step="2">
          <div class="panel-title">
            <div class="panel-icon">‚öñÔ∏è</div>
            Apply Category Weights
          </div>

          <div id="featureLayerCategoryWeights">
            <!-- Feature layer category weights will be populated by JavaScript -->
          </div>
        </div>

        <!-- SHARED STEPS -->
        <!-- Step 2: Configuration (for datasets only) -->
        <div class="step-content dataset-step" data-step="2">
          <div class="panel-title">
            <div class="panel-icon">‚öôÔ∏è</div>
            Configure Dataset
          </div>

          <div id="configurationSection">
            <div class="input-group">
              <label class="input-label">Dataset Name</label>
              <input type="text" id="projectName" placeholder="Enter dataset name">
            </div>

            <div class="input-group">
              <label class="input-label">Description</label>
              <textarea id="projectDescription" rows="3" placeholder="Describe your dataset..."></textarea>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="goToStep(1)">Back</button>
            <button class="btn btn-primary" onclick="continueFromStep2()">Continue</button>
          </div>
        </div>

        <!-- Step 3: Select Fields (shared) -->
        <div class="step-content" data-step="3">
          <div class="panel-title">
            <div class="panel-icon">‚úÖ</div>
            Select Fields to Include
          </div>

          <div class="quick-actions">
            <div class="quick-action" onclick="selectAll()">
              <strong>Select All</strong>
            </div>
            <div class="quick-action" onclick="selectNone()">
              <strong>Select None</strong>
            </div>
            <div class="quick-action" onclick="selectQuantitative()">
              <strong>Quantitative Only</strong>
            </div>
          </div>

          <div class="field-list" id="fieldList">
            <!-- Fields will be populated here -->
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="goToStep(2)">Back</button>
            <button class="btn btn-primary" onclick="goToStep(4)">Continue</button>
          </div>
        </div>

        <!-- Step 4: Apply Field Weights (shared) -->
        <div class="step-content" data-step="4">
          <div class="panel-title">
            <div class="panel-icon">‚öñÔ∏è</div>
            Apply Field Weights
          </div>

          <div class="status-message status-info">
            <span>‚ÑπÔ∏è</span>
            <span>Configure field weights and importance. Use the lock icon (üîí) to prevent a field from changing when others are adjusted. Total weight should equal 100%.</span>
          </div>

          <div class="quick-actions" style="margin-bottom: 1.5rem;">
            <div class="quick-action" onclick="resetWeightsEqual()">
              <strong>‚öñÔ∏è Equal Weights</strong>
            </div>
            <div class="quick-action" onclick="lockedFields.clear(); populateWeightControls()">
              <strong>üîì Unlock All</strong>
            </div>
          </div>

          <div id="weightControls">
            <!-- Weight controls will be populated here -->
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="goToStep(3)">Back</button>
            <button class="btn btn-primary" onclick="goToStep(5)">Continue</button>
          </div>
        </div>

        <!-- Step 5: Export (shared) -->
        <div class="step-content" data-step="5">
          <div class="panel-title">
            <div class="panel-icon">üíæ</div>
            Export Configuration
          </div>

          <div class="input-group">
            <label class="input-label">Final Name</label>
            <input type="text" id="finalProjectName" placeholder="Enter final name for your project">
          </div>

          <div class="input-group">
            <label class="input-label">Final Description</label>
            <textarea id="finalProjectDescription" rows="3" placeholder="Final description and notes..."></textarea>
          </div>

          <div class="btn-group">
            <button class="btn btn-secondary" onclick="goToStep(4)">Back</button>
            <button class="btn btn-primary" onclick="exportConfig()">
              Export Configuration
            </button>
          </div>

          <div style="margin-top: 2rem;">
            <h4 style="margin-bottom: 1rem;">Export Options:</h4>
            <div class="quick-actions">
              <div class="quick-action" onclick="downloadJSON()">
                <strong>üìÑ Download JSON</strong>
              </div>
              <div class="quick-action" onclick="copyPython()">
                <strong>üêç Copy Python Code</strong>
              </div>
              <div class="quick-action" onclick="saveToServer()">
                <strong>‚òÅÔ∏è Save to Server</strong>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel - Preview -->
      <div class="panel">
        <div class="panel-title">
          <div class="panel-icon">üëÅÔ∏è</div>
          Live Preview
        </div>

        <div class="preview-tabs">
          <button class="preview-tab active" onclick="switchPreview('data')">Data Sample</button>
          <button class="preview-tab" onclick="switchPreview('schema')">Schema</button>
          <button class="preview-tab" onclick="switchPreview('python')">Python Code</button>
          <button class="preview-tab" onclick="switchPreview('stats')">Statistics</button>
        </div>

        <div class="preview-content" id="previewContent">
          <div id="previewData" class="preview-pane">
            <p style="color: #999;">Select a project type to begin...</p>
          </div>
          <div id="previewSchema" class="preview-pane" style="display: none;">
            <p style="color: #999;">Schema will appear here...</p>
          </div>
          <div id="previewPython" class="preview-pane" style="display: none;">
            <pre><code>Python code will be generated here...</code></pre>
          </div>
          <div id="previewStats" class="preview-pane" style="display: none;">
            <p style="color: #999;">Statistics will appear here...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2025 CI Sentinel</p>
    <p>Created by Thomas Numnum</p>
  </footer>

  <!-- Load JavaScript modules in dependency order -->
  <!-- Core modules first -->
  <script src="{{ url_for('static', filename='scripts/jsonEditor/core_editor/core_navigation.js') }}"></script>

  <!-- Feature modules -->
  <script src="{{ url_for('static', filename='scripts/jsonEditor/core_editor/project_selection.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/jsonEditor/core_editor/project_builder.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/jsonEditor/core_editor/field_management.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/jsonEditor/core_editor/preview_export.js') }}"></script>

  <!-- Data loading modules (existing) -->
  <script src="{{ url_for('static', filename='scripts/jsonEditor/file_upload.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/jsonEditor/builtin_apis.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/jsonEditor/user_apis.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/jsonEditor/api_creator.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/jsonEditor/data_source_controller.js') }}"></script>

  <script>
    // Initialize the data source controller after all modules are loaded
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof initDataSourceController === 'function') {
        initDataSourceController();
      }
    });

    // Universal continue function that detects the context
    function continueFromStep2() {
      updateProjectConfiguration();

      if (projectType === 'dataset') {
        goToStep(3); // Go to field selection
      } else if (projectType === 'category' || projectType === 'featurelayer') {
        // For categories and feature layers, step 2 is weight assignment
        // Continue to field selection
        goToStep(3);
      }
    }
  </script>
</body>
</html>