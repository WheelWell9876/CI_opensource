<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Open Source CI Sentinel</title>

  <!-- Plotly for interactive map -->
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.20/dist/sweetalert2.all.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.20/dist/sweetalert2.min.css">

  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/index.css') }}">
  <!-- Mapbox-specific CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/mapbox.css') }}">
</head>

<body>
  <!-- HEADER with custom nav -->
  <header>
    <div class="logo">
      <div class="custom-loader"></div>
      <span class="logo-title">CI Sentinel</span>
    </div>
    <nav>
      <div class="nav-links-container">
        <li><a href="{{ url_for('main.index') }}">Home</a></li>
        <li><a href="{{ url_for('main.about') }}">About</a></li>
        <li><a href="{{ url_for('main.editor_page') }}">Editor</a></li>
        <li><a href="{{ url_for('main.datasets') }}">Datasets</a></li>
        <li><a href="{{ url_for('main.docs_page') }}">Docs</a></li>
        <li><a href="{{ url_for('main.contact') }}">Contact</a></li>
      </div>
    </nav>
  </header>

  <!-- MAIN CONTENT AREA -->
  <div class="main-layout">

    <!-- LEFT SIDEBAR with filters -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>üó∫Ô∏è Map Controls</h2>
        <p>Configure your data visualization</p>
      </div>

      <!-- Mode Selection -->
      <div class="filter-section">
        <label for="modeSelect">Mode</label>
        <select id="modeSelect">
          <option value="regular" selected>Regular Data</option>
          <option value="weighted">Weighted Data</option>
        </select>
      </div>

      <!-- Regular filters -->
      <div id="regularFilters" class="filter-group">
        <div class="filter-section">
          <label for="stateSelect">State</label>
          <select id="stateSelect">
            <option value="">Loading States...</option>
          </select>
        </div>

        <div class="filter-section">
          <label for="countySelect">County</label>
          <select id="countySelect" disabled>
            <option value="">(Optional) Choose County</option>
          </select>
        </div>

        <div class="filter-section">
          <label for="categorySelect">Category</label>
          <select id="categorySelect" disabled>
            <option value="">(Optional) Choose Category</option>
          </select>
        </div>

        <div class="filter-section">
          <label for="datasetSelect">Dataset</label>
          <select id="datasetSelect" disabled>
            <option value="">(Optional) Choose Dataset</option>
          </select>
        </div>
      </div>

      <!-- Weighted filters -->
      <div id="weightedFilters" class="filter-group" style="display:none;">
        <div class="filter-section">
          <label for="weightedDatasetSelect">Weighted Dataset</label>
          <select id="weightedDatasetSelect">
            <option value="">Loading Weighted Datasets...</option>
          </select>
        </div>
      </div>

      <!-- Display Options -->
      <div class="filter-section">
        <label for="displayMethodSelect">Display Method</label>
        <select id="displayMethodSelect">
          <option value="default" selected>Default (Points)</option>
          <option value="basic_heatmap">Basic Density Heatmap</option>
          <option value="weighted_heatmap">Weighted Density Heatmap</option>
          <option value="convex_hull">Convex Hull Over High-Weight Points</option>
          <option value="gaussian_kde">Gaussian KDE Contours</option>
          <option value="bubble_map">Bubble Map</option>
          <option value="choropleth">Choropleth Map</option>
          <option value="animated">Animated Transitions</option>
          <option value="extrusion">3D Extrusion</option>
          <option value="comparative">Comparative Overlays</option>
          <option value="interactive_filter">Interactive Filtering</option>
          <option value="voronoi">Voronoi Tessellation</option>
        </select>
      </div>

      <div id="weightTypeRow" class="filter-section" style="display: none;">
        <label for="weightTypeSelect">Weight Type</label>
        <select id="weightTypeSelect">
          <option value="original" selected>Original Weight</option>
          <option value="normalizedDatasetWeight">Normalized Dataset Weight</option>
          <option value="normalizedCategoryWeight">Normalized Category Weight</option>
          <option value="normalizedOverallWeight">Normalized Overall Weight</option>
        </select>
      </div>

      <!-- Advanced Controls -->
      <div id="advancedControls" class="filter-section">
        <label for="dataFractionSlider">Data Fraction: <span id="dataFractionValue">10</span>%</label>
        <input type="range" id="dataFractionSlider" min="1" max="100" value="10" class="slider">
      </div>

      <!-- Geometry Types -->
      <div class="filter-section">
        <label>Geometry Types</label>
        <div class="checkbox-group">
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="Point" checked>Point</label>
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="MultiPoint" checked>MultiPoint</label>
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="LineString" checked>LineString</label>
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="MultiLineString" checked>MultiLineString</label>
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="Polygon" checked>Polygon</label>
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="MultiPolygon" checked>MultiPolygon</label>
        </div>
      </div>

      <!-- Show/Hide Unavailable -->
      <div class="filter-section">
        <label>Availability</label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="showUnavailable" id="showUnavailable" value="show">
            Show Unavailable
          </label>
          <label class="radio-label">
            <input type="radio" name="showUnavailable" id="hideUnavailable" value="hide" checked>
            Hide Unavailable
          </label>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="button-group">
        <button id="submitBtn" class="btn btn-primary">
          <span class="material-icons">map</span>
          Generate Map
        </button>
        <button id="submitDisplayBtn" class="btn btn-secondary">
          <span class="material-icons">tune</span>
          Custom Display
        </button>
        <button id="resetBtn" class="btn btn-reset">
          <span class="material-icons">refresh</span>
          Reset
        </button>
      </div>
    </div>

    <!-- RIGHT MAIN AREA with map -->
    <div class="map-area">
      <div id="mapContainer"></div>
    </div>

  </div>

  <!-- FOOTER -->
  <footer>
    <div class="footer-content">
      <div class="footer-section contact">
        <h3>Contact</h3>
        <p><i class="material-icons">email</i>Coming soon...</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>CI Sentinel &copy; 2025 | coding by <a href="https://github.com/WheelWell9876/">Thomas Numnum</a></p>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='scripts/index.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/map/displayCustom.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/map/filters.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/map/mapRender.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/map/regularMapRender.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/map/widgets.js') }}"></script>
  <script>
    // Debug and initialization check
    $(document).ready(function() {
      console.log("=== APPLICATION STARTUP DEBUG ===");
      console.log("Available objects:", {
        AppState: typeof AppState,
        FilterManager: typeof FilterManager,
        jQuery: typeof $,
        Plotly: typeof Plotly
      });

      // Check if all required elements exist
      const requiredElements = [
        '#modeSelect', '#stateSelect', '#countySelect',
        '#categorySelect', '#datasetSelect', '#weightedDatasetSelect',
        '#submitBtn', '#resetBtn', '#mapContainer'
      ];

      requiredElements.forEach(selector => {
        const element = $(selector);
        if element.length === 0) {
          console.error("Missing required element:", selector);
        } else {
          console.log("Found element:", selector);
        }
      });

      console.log("=== END STARTUP DEBUG ===");
    });
  </script>
  <script>
    // Add this script to your HTML to ensure hover boxes work correctly
    $(document).ready(function() {
        // Function to fix hover box sizing after plot is rendered
        function fixHoverBoxes() {
            // Wait a bit for the plot to fully render
            setTimeout(function() {
                // Target all hover text elements and ensure they have fixed sizing
                $('.js-plotly-plot .plotly .hoverlayer .hovertext').css({
                    'width': '300px',
                    'height': '250px',
                    'max-width': '300px',
                    'max-height': '250px',
                    'min-width': '300px',
                    'min-height': '250px',
                    'overflow-y': 'auto',
                    'overflow-x': 'hidden',
                    'white-space': 'normal',
                    'word-wrap': 'break-word',
                    'display': 'block',
                    'visibility': 'visible'
                });
            }, 100);
        }

        // Fix hover boxes whenever the plot is updated
        $(document).on('plotly_hover plotly_relayout plotly_redraw', '#mapContainer', function() {
            fixHoverBoxes();
        });

        // Also fix on initial load
        $(document).on('plotly_afterplot', '#mapContainer', function() {
            fixHoverBoxes();
        });

        // Fallback: periodically check and fix hover boxes
        setInterval(function() {
            $('.js-plotly-plot .plotly .hoverlayer .hovertext').each(function() {
                const $hoverBox = $(this);
                if ($hoverBox.is(':visible') && ($hoverBox.width() !== 300 || $hoverBox.height() !== 250)) {
                    $hoverBox.css({
                        'width': '300px',
                        'height': '250px',
                        'max-width': '300px',
                        'max-height': '250px',
                        'overflow-y': 'auto',
                        'overflow-x': 'hidden'
                    });
                }
            });
        }, 500);
    });

    // Alternative approach: Override Plotly's hover behavior
    if (typeof Plotly !== 'undefined') {
        // Store original hover function
        const originalHover = Plotly.Fx.hover;

        // Override with our custom sizing
        Plotly.Fx.hover = function(gd, hoverData, hoverMode) {
            const result = originalHover.apply(this, arguments);

            // Apply our fixed sizing after hover is created
            setTimeout(function() {
                $('.js-plotly-plot .plotly .hoverlayer .hovertext').css({
                    'width': '300px !important',
                    'height': '250px !important',
                    'overflow-y': 'auto !important',
                    'overflow-x': 'hidden !important'
                });
            }, 10);

            return result;
        };
    }
  </script>
</body>
</html>