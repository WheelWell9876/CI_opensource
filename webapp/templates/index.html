<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Open Source CI Sentinel</title>

  <!-- Plotly for interactive map -->
  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"></script>
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.20/dist/sweetalert2.all.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.20/dist/sweetalert2.min.css">

  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">

  <!-- Custom CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/index.css') }}">
  <!-- Mapbox-specific CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/mapbox.css') }}">
</head>

<body>
  <!-- HEADER with custom nav -->
  <header>
    <div class="logo">
      <div class="custom-loader"></div>
      <span class="logo-title">CI Sentinel</span>
    </div>
    <nav>
      <div class="nav-links-container">
        <li><a href="{{ url_for('main.index') }}">Home</a></li>
        <li><a href="{{ url_for('main.about') }}">About</a></li>
        <li><a href="{{ url_for('main.editor_page') }}">Editor</a></li>
        <li><a href="{{ url_for('main.datasets') }}">Datasets</a></li>
        <li><a href="{{ url_for('main.docs_page') }}">Docs</a></li>
        <li><a href="{{ url_for('main.contact') }}">Contact</a></li>
      </div>
    </nav>
  </header>

  <!-- MAIN CONTENT AREA -->
  <div class="main-layout">

    <!-- LEFT SIDEBAR with filters -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>üó∫Ô∏è Map Controls</h2>
        <p>Configure your data visualization</p>
      </div>

      <!-- Mode Selection -->
      <div class="filter-section">
        <label for="modeSelect">Mode</label>
        <select id="modeSelect">
          <option value="regular" selected>Regular Data</option>
          <option value="weighted">Weighted Data</option>
        </select>
      </div>

      <!-- Regular filters -->
      <div id="regularFilters" class="filter-group">
        <div class="filter-section">
          <label for="stateSelect">State</label>
          <select id="stateSelect">
            <option value="">Loading States...</option>
          </select>
        </div>

        <div class="filter-section">
          <label for="countySelect">County</label>
          <select id="countySelect" disabled>
            <option value="">(Optional) Choose County</option>
          </select>
        </div>

        <div class="filter-section">
          <label for="categorySelect">Category</label>
          <select id="categorySelect" disabled>
            <option value="">(Optional) Choose Category</option>
          </select>
        </div>

        <div class="filter-section">
          <label for="datasetSelect">Dataset</label>
          <select id="datasetSelect" disabled>
            <option value="">(Optional) Choose Dataset</option>
          </select>
        </div>
      </div>

      <!-- Weighted filters -->
      <div id="weightedFilters" class="filter-group" style="display:none;">
        <div class="filter-section">
          <label for="weightedDatasetSelect">Weighted Dataset</label>
          <select id="weightedDatasetSelect">
            <option value="">Loading Weighted Datasets...</option>
          </select>
        </div>
      </div>

      <!-- Display Options -->
      <div class="filter-section">
        <label for="displayMethodSelect">Display Method</label>
        <select id="displayMethodSelect">
          <option value="default" selected>Default (Points)</option>
          <option value="basic_heatmap">Basic Density Heatmap</option>
          <option value="weighted_heatmap">Weighted Density Heatmap</option>
          <option value="convex_hull">Convex Hull Over High-Weight Points</option>
          <option value="gaussian_kde">Gaussian KDE Contours</option>
          <option value="bubble_map">Bubble Map</option>
          <option value="choropleth">Choropleth Map</option>
          <option value="animated">Animated Transitions</option>
          <option value="extrusion">3D Extrusion</option>
          <option value="comparative">Comparative Overlays</option>
          <option value="interactive_filter">Interactive Filtering</option>
          <option value="voronoi">Voronoi Tessellation</option>
        </select>
      </div>

      <div id="weightTypeRow" class="filter-section" style="display: none;">
        <label for="weightTypeSelect">Weight Type</label>
        <select id="weightTypeSelect">
          <option value="original" selected>Original Weight</option>
          <option value="normalizedDatasetWeight">Normalized Dataset Weight</option>
          <option value="normalizedCategoryWeight">Normalized Category Weight</option>
          <option value="normalizedOverallWeight">Normalized Overall Weight</option>
        </select>
      </div>

      <!-- Advanced Controls with Data Fraction Slider -->
      <div id="advancedControls" class="filter-section">
        <label for="dataFractionSlider">Data Fraction: <span id="dataFractionValue">10</span>%</label>
        <input type="range" id="dataFractionSlider" min="1" max="100" value="10" class="slider">
        <small style="color: #666; font-size: 11px; display: block; margin-top: 5px;">
          ‚ÑπÔ∏è Controls how much data to display (useful for large datasets)
        </small>
      </div>

      <!-- Geometry Types -->
      <div class="filter-section">
        <label>Geometry Types</label>
        <div class="checkbox-group">
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="Point" checked>Point</label>
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="MultiPoint" checked>MultiPoint</label>
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="LineString" checked>LineString</label>
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="MultiLineString" checked>MultiLineString</label>
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="Polygon" checked>Polygon</label>
          <label class="checkbox-label"><input type="checkbox" name="geomType" value="MultiPolygon" checked>MultiPolygon</label>
        </div>
      </div>

      <!-- Show/Hide Unavailable -->
      <div class="filter-section">
        <label>Availability</label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="showUnavailable" id="showUnavailable" value="show">
            Show Unavailable
          </label>
          <label class="radio-label">
            <input type="radio" name="showUnavailable" id="hideUnavailable" value="hide" checked>
            Hide Unavailable
          </label>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="button-group">
        <button id="submitBtn" class="btn btn-primary">
          <span class="material-icons">map</span>
          Generate Map
        </button>
        <button id="submitDisplayBtn" class="btn btn-secondary">
          <span class="material-icons">tune</span>
          Custom Display
        </button>
        <button id="resetBtn" class="btn btn-reset">
          <span class="material-icons">refresh</span>
          Reset
        </button>
      </div>
    </div>

    <!-- RIGHT MAIN AREA with map -->
    <div class="map-area">
      <div id="mapContainer"></div>
    </div>

  </div>

  <!-- FOOTER -->
  <footer>
    <div class="footer-content">
      <div class="footer-section contact">
        <h3>Contact</h3>
        <p><i class="material-icons">email</i>Coming soon...</p>
      </div>
    </div>
    <div class="footer-bottom">
      <p>CI Sentinel &copy; 2025 | coding by <a href="https://github.com/WheelWell9876/">Thomas Numnum</a></p>
    </div>
  </footer>

  <!-- JavaScript -->
  <script src="{{ url_for('static', filename='scripts/index.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/map/displayCustom.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/map/filters.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/map/mapRender.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/map/regularMapRender.js') }}"></script>
  <script src="{{ url_for('static', filename='scripts/map/widgets.js') }}"></script>

  <script>
    // Debug and initialization check
    $(document).ready(function() {
      console.log("=== APPLICATION STARTUP DEBUG ===");
      console.log("Available objects:", {
        AppState: typeof AppState,
        FilterManager: typeof FilterManager,
        jQuery: typeof $,
        Plotly: typeof Plotly
      });

      // Check if all required elements exist
      const requiredElements = [
        '#modeSelect', '#stateSelect', '#countySelect',
        '#categorySelect', '#datasetSelect', '#weightedDatasetSelect',
        '#submitBtn', '#resetBtn', '#mapContainer', '#dataFractionSlider'
      ];

      requiredElements.forEach(selector => {
        const element = $(selector);
        if element.length === 0) {
          console.error("Missing required element:", selector);
        } else {
          console.log("Found element:", selector);
        }
      });

      console.log("=== END STARTUP DEBUG ===");
    });
  </script>

  <script>
    // Add this script to your HTML to ensure hover boxes work correctly
    $(document).ready(function() {
        // Function to fix hover box sizing after plot is rendered
        function fixHoverBoxes() {
            // Wait a bit for the plot to fully render
            setTimeout(function() {
                // Target all hover text elements and ensure they have fixed sizing
                $('.js-plotly-plot .plotly .hoverlayer .hovertext').css({
                    'width': '300px',
                    'height': '250px',
                    'max-width': '300px',
                    'max-height': '250px',
                    'min-width': '300px',
                    'min-height': '250px',
                    'overflow-y': 'auto',
                    'overflow-x': 'hidden',
                    'white-space': 'normal',
                    'word-wrap': 'break-word',
                    'display': 'block',
                    'visibility': 'visible'
                });
            }, 100);
        }

        // Fix hover boxes whenever the plot is updated
        $(document).on('plotly_hover plotly_relayout plotly_redraw', '#mapContainer', function() {
            fixHoverBoxes();
        });

        // Also fix on initial load
        $(document).on('plotly_afterplot', '#mapContainer', function() {
            fixHoverBoxes();
        });

        // Fallback: periodically check and fix hover boxes
        setInterval(function() {
            $('.js-plotly-plot .plotly .hoverlayer .hovertext').each(function() {
                const $hoverBox = $(this);
                if ($hoverBox.is(':visible') && ($hoverBox.width() !== 300 || $hoverBox.height() !== 250)) {
                    $hoverBox.css({
                        'width': '300px',
                        'height': '250px',
                        'max-width': '300px',
                        'max-height': '250px',
                        'overflow-y': 'auto',
                        'overflow-x': 'hidden'
                    });
                }
            });
        }, 500);
    });

    // Alternative approach: Override Plotly's hover behavior
    if (typeof Plotly !== 'undefined') {
        // Store original hover function
        const originalHover = Plotly.Fx.hover;

        // Override with our custom sizing
        Plotly.Fx.hover = function(gd, hoverData, hoverMode) {
            const result = originalHover.apply(this, arguments);

            // Apply our fixed sizing after hover is created
            setTimeout(function() {
                $('.js-plotly-plot .plotly .hoverlayer .hovertext').css({
                    'width': '300px !important',
                    'height': '250px !important',
                    'overflow-y': 'auto !important',
                    'overflow-x': 'hidden !important'
                });
            }, 10);

            return result;
        };
    }
  </script>

  <!-- Add this script right before your closing </body> tag in index.html -->
  <script>
  $(document).ready(function() {
      // Simple debug logging for custom display
      $('#submitDisplayBtn').on('click', function() {
          const mode = $('#modeSelect').val();
          const displayMethod = $('#displayMethodSelect').val();
          const weightType = $('#weightTypeSelect').val();
          const dataset = $('#weightedDatasetSelect').val();

          console.log("üé® CUSTOM DISPLAY CLICKED:");
          console.log("  Mode:", mode);
          console.log("  Display Method:", displayMethod);
          console.log("  Weight Type:", weightType);
          console.log("  Dataset:", dataset);

          // Show what payload will be sent
          if (mode === "weighted") {
              const payload = {
                  mode: "weighted",
                  filters: { dataset: dataset },
                  display_method: displayMethod,
                  weight_type: weightType,
                  config: {
                      dataFraction: parseInt($('#dataFractionSlider').val()) / 100,
                      geometryTypes: Array.from($("input[name='geomType']:checked")).map(cb => cb.value),
                      showUnavailable: $("input[name='showUnavailable']:checked").val() === "show"
                  }
              };
              console.log("üì¶ Payload that will be sent:", JSON.stringify(payload, null, 2));
          }
      });

      // Monitor AJAX requests to /generate_map
      $(document).ajaxSend(function(event, xhr, settings) {
          if (settings.url === "/generate_map") {
              console.log("üöÄ AJAX REQUEST TO /generate_map:");
              try {
                  const payload = JSON.parse(settings.data);
                  console.log("  üìä Display Method:", payload.display_method);
                  console.log("  üéØ Mode:", payload.mode);
                  if (payload.weight_type) {
                      console.log("  ‚öñÔ∏è Weight Type:", payload.weight_type);
                  }
                  if (payload.config && payload.config.dataFraction) {
                      console.log("  üéöÔ∏è Data Fraction:", payload.config.dataFraction);
                  }
              } catch (e) {
                  console.log("  ‚ùå Could not parse payload");
              }
          }
      });

      $(document).ajaxSuccess(function(event, xhr, settings) {
          if (settings.url === "/generate_map") {
              console.log("‚úÖ AJAX SUCCESS:", xhr.status);
              try {
                  const response = JSON.parse(xhr.responseText);
                  if (response.figure) {
                      const figure = typeof response.figure === 'string' ? JSON.parse(response.figure) : response.figure;
                      console.log("üìà Figure has", figure.data?.length || 0, "traces");
                  }
              } catch (e) {
                  console.log("‚ùå Could not parse response");
              }
          }
      });

      $(document).ajaxError(function(event, xhr, settings, error) {
          if (settings.url === "/generate_map") {
              console.log("‚ùå AJAX ERROR:", xhr.status, "-", error);
              console.log("üìÑ Response:", xhr.responseText);
          }
      });
  });
  </script>

  <!-- Add this script temporarily to your index.html right before closing </body> tag to debug the slider -->
  <script>
  $(document).ready(function() {
      // Force debug the slider
      setTimeout(function() {
          console.log("üîç SLIDER DEBUG:");
          console.log("  - Slider element exists:", $('#dataFractionSlider').length > 0);
          console.log("  - Slider value:", $('#dataFractionSlider').val());
          console.log("  - Slider visible:", $('#dataFractionSlider').is(':visible'));
          console.log("  - Advanced controls exists:", $('#advancedControls').length > 0);
          console.log("  - Advanced controls visible:", $('#advancedControls').is(':visible'));
          console.log("  - Advanced controls display:", $('#advancedControls').css('display'));

          // Force show the advanced controls and slider
          $('#advancedControls').show();
          $('#advancedControls').css('display', 'block');

          // Log the slider's parent elements
          console.log("  - Slider parent chain:");
          $('#dataFractionSlider').parents().each(function(i, el) {
              console.log(`    Level ${i}:`, el.tagName, el.id, el.className, $(el).is(':visible'));
          });

          // Check if there are any CSS rules hiding it
          const slider = $('#dataFractionSlider')[0];
          if (slider) {
              const styles = window.getComputedStyle(slider);
              console.log("  - Computed styles:");
              console.log("    display:", styles.display);
              console.log("    visibility:", styles.visibility);
              console.log("    opacity:", styles.opacity);
              console.log("    height:", styles.height);
          }

          // Try to make it super visible
          $('#dataFractionSlider').css({
              'display': 'block !important',
              'visibility': 'visible !important',
              'opacity': '1 !important',
              'background-color': 'red',  // Temporary to make it obvious
              'height': '20px',
              'width': '100%'
          });

          $('#advancedControls').css({
              'display': 'block !important',
              'visibility': 'visible !important',
              'border': '2px solid red',  // Temporary to make it obvious
              'background-color': 'yellow'
          });

          console.log("üîç AFTER FORCING VISIBILITY:");
          console.log("  - Slider visible:", $('#dataFractionSlider').is(':visible'));
          console.log("  - Advanced controls visible:", $('#advancedControls').is(':visible'));

      }, 2000);
  });
  </script>

  <script>
  $(document).ready(function() {
      // Debug which button is being clicked
      $('#submitBtn').on('click', function() {
          console.log("üö® REGULAR SUBMIT BUTTON CLICKED!");
          console.log("  - This should NOT include config data");
      });

      $('#submitDisplayBtn').on('click', function() {
          console.log("üé® CUSTOM DISPLAY BUTTON CLICKED!");
          console.log("  - This SHOULD include config data");
          console.log("  - Slider value:", $('#dataFractionSlider').val());

          // Test if the slider value is being read correctly
          const dataFraction = parseInt($("#dataFractionSlider").val()) / 100;
          console.log("  - Calculated fraction:", dataFraction);
      });

      // Also check if there are multiple handlers
      const submitEvents = $._data($('#submitDisplayBtn')[0], 'events');
      console.log("üîç Events attached to Custom Display button:", submitEvents);

      // Check the button text and state
      console.log("üîç Button inspection:");
      console.log("  - Submit button text:", $('#submitBtn').text());
      console.log("  - Custom Display button text:", $('#submitDisplayBtn').text());
      console.log("  - Custom Display button exists:", $('#submitDisplayBtn').length > 0);
      console.log("  - Custom Display button visible:", $('#submitDisplayBtn').is(':visible'));
  });
  </script>

</body>
</html>